################ VULNERABILITY

vulnerability <- function(land, MASK, a){
  
  vuln <- select(land, cell.id, spp, age, elev, temp, prec, soil.type)
  
  ## host predisposition
  breaks <- c(0,20,40,60,80,100,999)
  tags <- c("C10","C30", "C50", "C70", "C90", "OLD")
  vuln$age.class <- cut(vuln$age, breaks=breaks, include.lowest=TRUE, right=TRUE, labels=tags)
  vuln$host.pref <- ifelse(vuln$spp=="SAB" & vuln$age.class %in% c("C50", "C70", "C90", "OLD"), 1,
                            ifelse(vuln$spp=="SAB" & vuln$age.class %in% c("C10", "C30"), 0.75,
                                   ifelse(vuln$spp=="EPN" & vuln$age.class %in% c("C50", "C70", "C90", "OLD"), 0.5,
                                          ifelse(vuln$spp=="EPN" & vuln$age.class %in% c("C10", "C30"), 0.25, 0))))
  
  
  ## elevation
  vuln$elev <- scales::rescale(vuln$elev, to=c(-3,3))
  vuln$elev.modif <- 1 -1/(1+exp(-vuln$elev*2))
  # plot(elev, elev.modif)
  
  ## Soil and climatic suitability per spp. 
  ## Overall suitability corresponds to the minimum value between soil and climate suitability
  suboptimal <- 0.5
  list.spp <- levels(vuln$spp)
  list.spp <- list.spp[list.spp!="NonFor"]
  temp.suitability <- read.table("inputfiles/ThMeanTemp.txt", header=T)  
  prec.suitability <- read.table("inputfiles/ThAnnualPrecip.txt", header=T)  
  soil.suitability <- read.table("inputfiles/ThSoil.txt", header=T)  
  dta <- data.frame(cell.id=NA, spp=NA, site.qual=NA)
  for(ispp in list.spp){
    th.temp <- filter(temp.suitability, spp==ispp)[-1]
    th.prec <- filter(prec.suitability, spp==ispp)[-1] 
    th.soil <- filter(soil.suitability, spp==ispp)[-1]
    aux <- filter(vuln, spp==ispp) %>%  #data.frrame(cell.id=vuln$cell.id, potential.spp=ispp, temp=vuln$temp, prec=vuln$prec, soil=vuln$soil.type) %>%
           mutate(class.temp=as.numeric(cut(temp, th.temp)),
             class.prec=as.numeric(cut(prec, th.prec)),
             suit.temp=ifelse(is.na(class.temp), 0, ifelse(class.temp==2, 1, suboptimal)),
             suit.prec=ifelse(is.na(class.prec), 0, ifelse(class.prec==2, 1, suboptimal)),
             suit.soil=as.numeric(th.soil[match(soil.type, c("T","O","R","S","A"))]),
             suit.clim=pmin(suit.temp, suit.prec),
             site.qual=pmin(suit.soil, suit.clim))  %>%
      select(cell.id, spp, site.qual)
    dta <- rbind(dta, aux)
  }
  dta <- dta[-1,]
  aux <- filter(vuln, spp=="NonFor") %>% mutate(site.qual=0) %>% select(cell.id, spp, site.qual)
  dta <- rbind(dta, aux) 
  vuln <- left_join(vuln, dta, by=c("cell.id", "spp"))
  
  ## Host prevalence or preference in the neighborhood
  neighs <- data.frame(x=c(-1,1,ncol(MASK),-ncol(MASK),ncol(MASK)-1,-(ncol(MASK)+1),ncol(MASK)+1,-(ncol(MASK)-1),
                           -2,2,ncol(MASK)*2,-ncol(MASK)*2),
                       w=c(1,1,1,1,0.75,0.75,0.75,0.75,0.5,0.5,0.5,0.5))
  nneigh <- nrow(neighs)
  # cell.id of hosts
  host <- land$cell.id[land$spp %in% c("SAB", "EPN")]
  # compute weighted mean of neigh's host.pref
  neigh.host.pref <- data.frame(cell.id=rep(host, each=nneigh) + rep(neighs$x, length(host)),
                                w=rep(neighs$w, length(host)),
                                source.id=rep(host, each=nneigh))  %>% 
                     filter(cell.id %in% land$cell.id) %>% 
                     left_join(select(vuln, cell.id, host.pref), by="cell.id") %>% 
                     group_by(source.id) %>% summarise(neigh.host.pref=mean(host.pref*w))
  # add hosts without neigbhors
  without.neigh <- !(host %in% neigh.host.pref$source.id)
  neigh.host.pref <- rbind(neigh.host.pref, data.frame(source.id=host[without.neigh], neigh.host.pref=0))
  
    # join to the main data.frame
  vuln <- left_join(vuln, neigh.host.pref, by=c("cell.id"="source.id"))
                    

  ## Compute overall vuln
  vuln <- mutate(vuln, x=(site.qual+elev.modif+neigh.host.pref)/3,
                 v=(host.pref+a*x)/(1+a))
  # vuln$v[is.na(vuln$v)] <- 0  ## vulnerability of non-host is 0 or NA?

  return(vuln)
}

# head(vuln)                    
# group_by(vuln, spp, factor(host.pref)) %>% summarise(v=mean(v))
# hist(vuln$v[vuln$v>0])
